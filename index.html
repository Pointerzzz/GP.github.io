<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>ä¸­å›½èŒ¶äº§ä¸šç»¿è‰²å¯æŒç»­è¯„ä¼°ç³»ç»Ÿ</title>

    <!-- font -->
    <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.css">
    <!-- AOS -->
    <link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&display=swap">

    <link rel="stylesheet" type="text/css" href="assets/css/index.css">
    <link rel="stylesheet" type="text/css" href="assets/css/navbar.css">
    <!-- bootstrap -->
    <link rel="stylesheet" href="assets/css/main.css">

    <!-- å¼•å…¥é«˜å¾·åœ°å›¾ JSAPI -->
    <script type="text/javascript"
        src="https://webapi.amap.com/maps?v=2.0&key=e769a3af2b315d06adf04e42841ec191"></script>
    <script>
        window.addEventListener('load', function () {
            var loader = document.getElementById('loader');

            setTimeout(function () {
                loader.style.display = 'none';
            }, 2000);
        });
    </script>
</head>

<body>
    <div id="loader">
        <img src="./img/loader.gif" alt="Loading...">
    </div>

    <div class="header">
        <div>
            <nav class="navbar navbar-expand-md">
                <a href="" class="navbar-brand"><img src="./IMG/NJAU.png" alt="" class="logo"></a>
                <a href="" class="navbar-brand"><img src="./IMG/ZJU.png" alt="" class="logo2"></a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navmenu"
                    title="button">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navmenu">
                    <ul class="nav-list navbar-nav ms-auto">
                        <div class="second nav-item">
                            <img class="ims" src="./img/icon1.png" alt="">
                            <li class="cool-link first"><a href="index.html">
                                    <div class="nav-link">é¦–é¡µ</div>
                                </a>
                                <ul>
                                </ul>
                            </li>
                        </div>
                        <div class="second nav-item">
                            <img class="ims" src="./img/icon1.png" alt="">
                            <li class="cool-link first"><a href="./pages/optimize.html">
                                    <div class="nav-link">ç›®æ ‡ä¼˜åŒ–</div>
                                </a>
                                <ul>
                                </ul>
                            </li>
                        </div>
                        <div class="second nav-item">
                            <img class="ims" src="./img/icon1.png" alt="">
                            <li class=" cool-link first"><a href="./pages/carbonFootprint.html">
                                    <div class="nav-link">ç¢³è¶³è¿¹</div>
                                </a>
                                <ul>
                                </ul>
                            </li>
                        </div>
                        <div class="second nav-item">
                            <img class="ims" src="./img/icon1.png" alt="">
                            <li class=" cool-link first"><a href="#">
                                    <div class="nav-link">ä¸‹è½½ä¸­å¿ƒ</div>
                                </a>
                                <ul>
                                    <li><a href="./pages/download_model.html">
                                            <div><img src="./img/icon2.png" alt="">æ¨¡å‹ä¸‹è½½</div>
                                        </a></li>
                                    <li><a href="./pages/download_data.html">
                                            <div><img src="./img/icon2.png" alt="">æ•°æ®ä¸‹è½½</div>
                                        </a></li>
                                    <li><a href="./pages/download_png.html">
                                            <div><img src="./img/icon2.png" alt="">æ€§èƒ½å›¾ç‰‡ä¸‹è½½</div>
                                        </a></li>
                                </ul>
                            </li>
                        </div>
                    </ul>
                </div>
            </nav>
        </div>
    </div>

    <!-- å¤´å›¾ -->
    <section class="section0">
        <img src="./img/head.jpg" alt="">
    </section>

    <div class="container">
        <div class="title-section">
            <h1 class="main-title">ä¸­å›½èŒ¶äº§ä¸šç»¿è‰²å¯æŒç»­å‘å±•è¯„ä¼°ç³»ç»Ÿ</h1>
        </div>
        <div class="sub-title">èŒ¶å¶ç§æ¤ç‚¹ä¿¡æ¯</div>
        <div id="map" class="map-container"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script>
        var nav = document.querySelectorAll('.second');
        for (var i = 0; i < nav.length; i++) {
            nav[i].addEventListener('mouseenter', function () {
                var first = this.querySelector('.first');
                var secondChild = first.children[1];
                var img = this.querySelector('.ims');

                secondChild.style.opacity = "0";
                secondChild.style.transition = "opacity 0.5s";
                secondChild.style.display = "block";

                setTimeout(function () {
                    secondChild.style.opacity = "1";
                }, 200);

                img.classList.add("fade-out");

                img.addEventListener("transitionend", function () {
                    img.src = "./img/icon2.png";
                    img.classList.remove("fade-out");
                }, { once: true });
            });

            nav[i].addEventListener('mouseleave', function () {
                var first = this.querySelector('.first');
                var secondChild = first.children[1];
                var img = this.querySelector('.ims');

                secondChild.style.opacity = "0";
                secondChild.style.transition = "opacity 0.3s";

                img.classList.add("fade-out");

                img.addEventListener("transitionend", function () {
                    secondChild.style.display = "none";
                    img.src = "./img/icon1.png";
                    img.classList.remove("fade-out");
                }, { once: true });
            });
        }




        window.addEventListener('DOMContentLoaded', function () {
            updateLayout(); // æ‰‹åŠ¨è§¦å‘ä¸€æ¬¡æ›´æ–°å¸ƒå±€å‡½æ•°
        });

        window.addEventListener('resize', function () {
            updateLayout();
        });

        function updateLayout() {
            if (window.innerWidth < 768) {
                var img = document.getElementsByClassName('ims');
                for (var i = 0; i < img.length; i++) {
                    img[i].style.width = '15%';
                }

                var secondUls = document.querySelectorAll('.second ul');
                secondUls.forEach(function (ul) {
                    ul.style.top = '0';
                    ul.style.right = '80px';
                    ul.style.width = '375%';
                });
            } else {
                var img = document.getElementsByClassName('ims');
                for (var i = 0; i < img.length; i++) {
                    img[i].style.width = '22%';
                }

                var secondUls = document.querySelectorAll('.second ul');
                secondUls.forEach(function (ul) {
                    ul.style.top = '40px';
                    ul.style.right = '-45px';
                    ul.style.width = '268%';
                });
            }
        }
    </script>
    <script>
        // åˆ›å»ºä¸€ä¸ªå˜é‡æ¥å­˜å‚¨å½“å‰æ‰“å¼€çš„ä¿¡æ¯çª—ä½“
        let currentInfoWindow = null;

        // åˆå§‹åŒ–åœ°å›¾
        const map = new AMap.Map('map', {
            zoom: 6,
            center: [113.08, 28.25],
            viewMode: '3D'
        });

        // æ·»åŠ æ§ä»¶
        map.plugin(['AMap.ToolBar', 'AMap.Scale'], function () {
            map.addControl(new AMap.ToolBar());
            map.addControl(new AMap.Scale());
        });

        // åˆ›å»ºè‡ªå®šä¹‰æ ‡è®°å›¾æ ‡
        const teaIcon = {
            image: 'IMG/èŒ¶å¶.png',
            size: new AMap.Size(32, 32),
            imageSize: new AMap.Size(32, 32)
        }

        // æ·»åŠ åœ°å›¾ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
        map.on('click', function (e) {
            // æ£€æŸ¥ç‚¹å‡»æ˜¯å¦å‘ç”Ÿåœ¨æ ‡è®°ä¸Š
            const isMarkerClick = e.target && e.target.getExtData && e.target.getExtData().isMarker;

            // å¦‚æœç‚¹å‡»ä¸æ˜¯å‘ç”Ÿåœ¨æ ‡è®°ä¸Šä¸”æœ‰æ‰“å¼€çš„ä¿¡æ¯çª—ä½“ï¼Œåˆ™å…³é—­å®ƒ
            if (!isMarkerClick && currentInfoWindow) {
                currentInfoWindow.close();
                currentInfoWindow = null;
            }
        });

        // æ•°æ®åˆ†ç±»å®šä¹‰
        const dataCategories = {
            "åœ°ç†ä½ç½®ä¿¡æ¯": {
                icon: "ğŸŒ",
                fields: {
                    "ç»åº¦": "longitude",
                    "çº¬åº¦": "latitude",
                    "æµ·æ‹”": ["Altitude(m)", "m"]
                }
            },
            "æ°”è±¡ä¿¡æ¯": {
                icon: "ğŸŒ¤",
                fields: {
                    "å¹´é™æ°´é‡": ["Precipitation(mm)", "mm"],
                    "å¹³å‡æ¸©åº¦": ["Average Temperature (Â°C)", "Â°C"]
                }
            },
            "åœŸå£¤ä¿¡æ¯": {
                icon: "ğŸŒ±",
                fields: {
                    "pHå€¼": "pH",
                    "å…¨æ°®å«é‡": ["TN(g/kg-1)", "g/kg"],
                    "æœ‰æ•ˆç£·": ["AP (mg/kg-1)", "mg/kg"],
                    "é€Ÿæ•ˆé’¾": ["AK(mg/kg-1)", "mg/kg"],
                    "æœ‰æœºç¢³": ["SOC(%)", "%"]
                }
            },
            "å“ç§ä¿¡æ¯": {
                icon: "ğŸƒ",
                fields: {
                    "å¤§å¶ç§": "Large-leaved variety",
                    "ä¸­å¶ç§": "Medium-leaved variety",
                    "å°å¶ç§": "small-leaved variety",
                    "ç§æ¤å¹´é™": "Years of planting"
                }
            },
            "æ–½è‚¥ä¿¡æ¯": {
                icon: "ğŸ’Š",
                fields: {
                    "åŒ–è‚¥ç”¨é‡": ["N quantity(kg/y/hm2)", "kg/y/hmÂ²"],
                    "ç£·è‚¥ç”¨é‡": ["P2O5 quantity(kg/y/hm2)", "kg/y/hmÂ²"],
                    "é’¾è‚¥ç”¨é‡": ["K2O quantity(kg/y/hm2)", "kg/y/hmÂ²"],
                    "æœ‰æœºè‚¥ç”¨é‡": ["organic fertilizer quantity(kg`y/hm2)", "kg/y/hmÂ²"]
                }
            },
            "äº§é‡ä¿¡æ¯": {
                icon: "ğŸ“Š",
                fields: {
                    "é²œå¶äº§é‡": ["Fresh Shoot Yield(kg/667m2)_MEAN", "kg/667mÂ²"]
                }
            }
        };

        // ç”Ÿæˆä¿¡æ¯å†…å®¹çš„å‡½æ•°
        function generateCategoryContent(data, category) {
            const fields = dataCategories[category].fields;
            let content = "";

            for (const [label, field] of Object.entries(fields)) {
                let value, unit = '';
                if (Array.isArray(field)) {
                    value = data[field[0]];
                    unit = field[1];
                } else {
                    value = data[field];
                }

                if (value !== undefined && value !== '') {
                    content += `<p>${label}: ${value}${unit}</p>`;
                }
            }

            return content;
        }

        function createInfoWindowContent(point) {
            let content = `
<div style="
    padding: 20px;
    background-color: white;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    min-width: 350px;
    font-family: 'Microsoft YaHei', sans-serif;
">
    <h3 style="
        margin: 0 0 20px 0;
        padding-bottom: 12px;
        border-bottom: 2px solid #2c9678;
        color: #2c9678;
        font-size: 18px;
        display: flex;
        align-items: center;
    ">
        <img src="IMG/èŒ¶å¶.png" style="width: 24px; height: 24px; margin-right: 8px;">
        èŒ¶å¶ç§æ¤ç‚¹è¯¦ç»†ä¿¡æ¯
    </h3>
`;

            // åˆ›å»ºåˆ†ç±»æŠ˜å é¢æ¿
            for (const [category, categoryInfo] of Object.entries(dataCategories)) {
                const categoryId = `category-${category}-${point.longitude}-${point.latitude}`.replace(/\s+/g, '-');

                content += `
    <div style="margin-bottom: 12px;">
        <div onclick="toggleCategory('${categoryId}')" 
             style="
                cursor: pointer;
                padding: 10px 15px;
                background-color: #f8f9fa;
                border-radius: 8px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                transition: background-color 0.3s;
                border: 1px solid #e9ecef;
                &:hover {
                    background-color: #e9ecef;
                }
             ">
            <span style="
                display: flex;
                align-items: center;
                font-weight: 500;
                color: #495057;
            ">
                <span style="margin-right: 8px; font-size: 16px;">${categoryInfo.icon}</span>
                ${category}
            </span>
            <span id="arrow-${categoryId}" 
                  style="
                    transform: rotate(-90deg);
                    transition: transform 0.3s;
                    color: #6c757d;
                    font-size: 12px;
                  ">â–¼</span>
        </div>
        <div id="${categoryId}" 
             style="
                display: none;
                padding: 15px;
                background-color: #fff;
                border: 1px solid #e9ecef;
                border-top: none;
                margin-top: -1px;
                border-radius: 0 0 8px 8px;
             ">
            ${generateCategoryContent(point, category)}
        </div>
    </div>
`;
            }

            content += `</div>`;
            return content;
        }

        // é‡å†™ç”Ÿæˆåˆ†ç±»å†…å®¹çš„å‡½æ•°ä»¥æ·»åŠ æ›´å¥½çš„æ ·å¼
        function generateCategoryContent(data, category) {
            const fields = dataCategories[category].fields;
            let content = '<div style="display: grid; grid-template-columns: auto 1fr; gap: 8px;">';

            for (const [label, field] of Object.entries(fields)) {
                let value, unit = '';
                if (Array.isArray(field)) {
                    value = data[field[0]];
                    unit = field[1];
                } else {
                    value = data[field];
                }

                if (value !== undefined && value !== '') {
                    content += `
        <div style="color: #6c757d; text-align: right; padding-right: 10px;">${label}:</div>
        <div style="color: #212529; font-weight: 500;">${value}${unit}</div>
    `;
                }
            }

            content += '</div>';
            return content;
        }

        // æ›´æ–°åˆ‡æ¢å‡½æ•°ä»¥æ·»åŠ å¹³æ»‘åŠ¨ç”»
        window.toggleCategory = function (categoryId) {
            const element = document.getElementById(categoryId);
            const arrow = document.getElementById(`arrow-${categoryId}`);
            const parentDiv = element.previousElementSibling;

            if (element) {
                const isVisible = element.style.display !== 'none';

                // åˆ‡æ¢æ˜¾ç¤ºçŠ¶æ€
                element.style.display = isVisible ? 'none' : 'block';

                // æ›´æ–°ç®­å¤´æ—‹è½¬
                if (arrow) {
                    arrow.style.transform = isVisible ? 'rotate(-90deg)' : 'rotate(0deg)';
                }

                // æ›´æ–°çˆ¶divçš„è¾¹æ¡†åœ†è§’
                if (isVisible) {
                    parentDiv.style.borderRadius = '8px';
                } else {
                    parentDiv.style.borderRadius = '8px 8px 0 0';
                }
            }
        };

        // åˆ›å»ºæ ‡è®°æ—¶çš„ä¿®æ”¹
        Papa.parse('database_yield.csv', {
            download: true,
            header: true,
            encoding: "UTF-8",
            complete: function (results) {
                results.data.forEach(point => {
                    if (point.longitude && point.latitude) {
                        const longitude = parseFloat(point.longitude);
                        const latitude = parseFloat(point.latitude);

                        if (!isNaN(longitude) && !isNaN(latitude)) {
                            const marker = new AMap.Marker({
                                position: [longitude, latitude],
                                title: 'èŒ¶å¶ç§æ¤ç‚¹',
                                icon: new AMap.Icon(teaIcon),
                                offset: new AMap.Pixel(-16, -16),
                                extData: { isMarker: true }  // æ·»åŠ æ ‡è®°æ ‡è¯†
                            });

                            const infoWindow = new AMap.InfoWindow({
                                content: createInfoWindowContent(point),
                                offset: new AMap.Pixel(0, -30),
                                isCustom: true
                            });

                            marker.on('click', () => {
                                // å¦‚æœå·²ç»æœ‰æ‰“å¼€çš„ä¿¡æ¯çª—ä½“ï¼Œå…ˆå…³é—­å®ƒ
                                if (currentInfoWindow) {
                                    currentInfoWindow.close();
                                }
                                // æ‰“å¼€æ–°çš„ä¿¡æ¯çª—ä½“å¹¶æ›´æ–°å¼•ç”¨
                                infoWindow.open(map, marker.getPosition());
                                currentInfoWindow = infoWindow;
                            });

                            marker.setMap(map);
                        }
                    }
                });
            },
            error: function (error) {
                console.error("CSV åŠ è½½é”™è¯¯:", error.message);
            }
        });
    </script>
</body>

</html>